<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Analytics - MediVault EHR</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <a href="{{ url_for('analytics_redirect') }}" class="nav-link">üìä System Analytics</a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4f46e5;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card h3 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 8px 0;
        }
        
        .metric-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }
        
        .metric-card .change {
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .change.positive {
            color: #059669;
        }
        
        .change.negative {
            color: #dc2626;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-canvas {
            max-height: 400px;
        }
        
        .data-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .table-container h3 {
            margin: 0 0 20px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .export-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .export-btn:hover {
            background: #4338ca;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #10b981;
        }
        
        .status-pending {
            background-color: #f59e0b;
        }
        
        .status-inactive {
            background-color: #ef4444;
        }
        
        @media (max-width: 768px) {
            .charts-grid,
            .data-tables {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <header style="margin-bottom: 30px;">
            <h1 style="color: #111827; font-size: 28px; font-weight: 700; margin: 0;">
                üìä System Analytics Dashboard
            </h1>
            <p style="color: #6b7280; margin: 8px 0 0 0;">
                Comprehensive insights into your MediVault EHR platform
            </p>
        </header>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Total Users</h3>
                <p class="value">{{ metrics.total_users }}</p>
                <div class="change positive">
                    ‚Üó +{{ metrics.new_users_30d }} this month
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Active Patients</h3>
                <p class="value">{{ metrics.total_patients }}</p>
                <div class="change">
                    {{ "%.1f"|format((metrics.total_patients / metrics.total_users * 100) if metrics.total_users > 0 else 0) }}% of all users
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Verified Doctors</h3>
                <p class="value">{{ metrics.verified_doctors }}</p>
                <div class="change {{ 'pending' if metrics.pending_doctors > 0 else 'positive' }}">
                    {{ metrics.pending_doctors }} pending verification
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Medical Files</h3>
                <p class="value">{{ metrics.total_files }}</p>
                <div class="change positive">
                    +{{ metrics.new_files_30d }} uploaded this month
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Total Storage</h3>
                <p class="value">{{ metrics.total_storage_mb }} MB</p>
                <div class="change">
                    Avg: {{ "%.1f"|format(metrics.avg_file_size_mb) }} MB per file
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Appointments</h3>
                <p class="value">{{ metrics.total_appointments }}</p>
                <div class="change positive">
                    +{{ metrics.new_appointments_30d }} scheduled this month
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="export-buttons">
            <button class="export-btn" onclick="exportData('users')">
                üìÑ Export Users
            </button>
            <button class="export-btn" onclick="exportData('files')">
                üìÅ Export Files
            </button>
            <button class="export-btn" onclick="generateReport()">
                üìä Generate Report
            </button>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>User Growth Trends</h3>
                <canvas id="userGrowthChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>File Categories Distribution</h3>
                <canvas id="fileCategoriesChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="data-tables">
            <div class="table-container">
                <h3>Most Active Patients</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Files Uploaded</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in metrics.active_patients %}
                        <tr>
                            <td>{{ patient.name }}</td>
                            <td>{{ patient.file_count }}</td>
                            <td>
                                <span class="status-indicator status-active"></span>
                                Active
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="table-container">
                <h3>System Health Status</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Last Check</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Database</td>
                            <td>
                                <span class="status-indicator status-active"></span>
                                Online
                            </td>
                            <td id="db-check-time">--</td>
                        </tr>
                        <tr>
                            <td>File Storage</td>
                            <td>
                                <span class="status-indicator status-active"></span>
                                Available
                            </td>
                            <td>Just now</td>
                        </tr>
                        <tr>
                            <td>Error Logs (24h)</td>
                            <td>
                                <span class="status-indicator status-active"></span>
                                <span id="error-count">0</span> errors
                            </td>
                            <td id="error-check-time">--</td>
                        </tr>
                        <tr>
                            <td>Active Sessions</td>
                            <td>
                                <span class="status-indicator status-active"></span>
                                <span id="active-sessions">--</span> users
                            </td>
                            <td id="session-check-time">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Initialize charts
        let userGrowthChart, fileCategoriesChart;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadSystemHealth();
            
            // Refresh system health every 30 seconds
            setInterval(loadSystemHealth, 30000);
        });

        function initializeCharts() {
            // User Growth Chart
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            
            fetch('/analytics/admin/api/user-growth?days=30')
                .then(response => response.json())
                .then(data => {
                    userGrowthChart = new Chart(userGrowthCtx, {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error loading user growth data:', error));

            // File Categories Chart
            const fileCategoriesCtx = document.getElementById('fileCategoriesChart').getContext('2d');
            
            fetch('/analytics/admin/api/file-categories')
                .then(response => response.json())
                .then(data => {
                    fileCategoriesChart = new Chart(fileCategoriesCtx, {
                        type: 'doughnut',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error loading file categories data:', error));
        }

        function loadSystemHealth() {
            fetch('/analytics/api/system-health')
                .then(response => response.json())
                .then(data => {
                    const now = new Date().toLocaleTimeString();
                    
                    document.getElementById('db-check-time').textContent = now;
                    document.getElementById('error-count').textContent = data.error_logs_24h;
                    document.getElementById('error-check-time').textContent = now;
                    document.getElementById('active-sessions').textContent = data.active_sessions;
                    document.getElementById('session-check-time').textContent = now;
                })
                .catch(error => {
                    console.error('Error loading system health:', error);
                    // Update UI to show error state
                    document.querySelectorAll('.status-indicator').forEach(indicator => {
                        indicator.className = 'status-indicator status-inactive';
                    });
                });
        }

        function exportData(dataType) {
            const url = `/analytics/export/${dataType}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `${dataType}_export.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateReport() {
            // Show loading state
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Generating...';
            btn.disabled = true;

            // Simulate report generation
            setTimeout(() => {
                alert('üìä Comprehensive system report has been generated and will be available in your downloads.');
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        }

        // Real-time updates simulation
        function simulateRealTimeUpdates() {
            // This would typically connect to a WebSocket for real-time updates
            setInterval(() => {
                // Update random metrics with small changes
                const metricCards = document.querySelectorAll('.metric-card .value');
                metricCards.forEach((card, index) => {
                    if (Math.random() > 0.9) { // 10% chance of update
                        const currentValue = parseInt(card.textContent);
                        const change = Math.random() > 0.5 ? 1 : -1;
                        card.textContent = Math.max(0, currentValue + change);
                        
                        // Add flash effect
                        card.style.background = '#eff6ff';
                        setTimeout(() => {
                            card.style.background = 'transparent';
                        }, 500);
                    }
                });
            }, 10000); // Update every 10 seconds
        }

        // Uncomment to enable real-time updates simulation
        // simulateRealTimeUpdates();
    </script>
</body>
</html>